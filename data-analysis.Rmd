---
title: Traffic Data Analysis
output: html_document
---

```{r}
library(ggplot2)
library(dplyr)
library(knitr)
library(tidyr)
```

# Data Processing

## Initialization

We first load our CSV file and take a glimpse at its contents.

```{r}
data.raw <- read.csv('all-semi-unique.csv')
glimpse(data.raw)
```

At first glance, we see that our raw data is composed of approximately 430k observations of 34 variables. Let us proceed to clean this data.

## Advertising data removal

Knowing that variables prefixed with **ad.** contain information relevant only to the application's advertising logic, we may safely drop them as they will not be used in our investigation.

```{r}
data.road <- data.raw %>% select(-(starts_with("ad.")))
```

## Removing constant valued columns

Now that we have dropped variables that will not be of interest, we can investigate for variables that always carry a constant value in our observations

```{r}
data.road %>%
  sapply(unique) %>%
  sapply(length)
```

We can spot two variables that are always constant: **rd.cl** and **rd.rp.type**. Since they add no information to our data, we may safely discard them. We then take note of the format the *crawl_date* variable is in.

```{r}
data.road <- data.road %>% select(-(rd.cl), -(rd.rp.type))
head(data.road$crawl_date)
```

## Crawl date format

The crawl_date column currently contains a factor of different strings. We proceed to parse this into a more machine readable format as a column of time values.

```{r}
data.road$crawl_date <- 
  strptime(data.road$crawl_date, format = "%a %b %e %X UTC %Y", tz = "UTC") %>% 
  as.POSIXct()
head(data.road$crawl_date)
```

## Report submission time estimation

Upon further inspection of bey2ollak.com's response data: **rd.rp.hr** and **rd.rp.mn** are the time differences between the crawl date and the report submission time. This means we can estimate the time of the response submission accurately down to a minute, which should be sufficient for our purposes. 

```{r}
data.road <- data.road %>%
  mutate(report_time = as.POSIXct(round(crawl_date - (rd.rp.hr*60*60 + rd.rp.mn*60), "mins"))) %>%
  select(-c(rd.rp.mn, rd.rp.hr))
```

## Road status update time estimation

**rd.hr** and **rd.mn** reflect how much time has passed since a road's status was updated on bey2ollak's end. We can extrapolate the last time a road's status was updated using similar means.

```{r}
data.road <- data.road %>%
  mutate(last_road_update = as.POSIXct(round(crawl_date - (rd.hr*60*60 + rd.mn*60), "mins"))) %>%
  select(-c(rd.mn, rd.hr))
```

## Road name split

We note that **rd.nm** contains a combination of the major road name and the minor road name. Splitting this column into two separate columns will help clarify more information about major roads and their minor segments.

```{r}
data.road <- data.road %>%
  separate(rd.nm, c("rd.majornm", "rd.minornm"), ";")
```

Some reports belong to a major road name as a whole with no minor road name. We proceed to replace the missing minor road names with a standard value.

```{r}
data.road$rd.minornm[is.na(data.road$rd.minornm)] <- "NO_MINOR"
```

## Extracting road status snapshots

Each crawl of the data represents a snapshot of all the road statuses at that time if we have the right perspective. Since every entry in our data is the road status data appended to some report data, we can isolate the road status information for analysis.

First, let us ensure that the missing values in rd.stid are not repairable through referring to another data entry in the same crawl.
```{r}
numberOfTripletsWithSTID <- data.road %>% select(crawl_date, rd.ri, rd.stid) %>% unique() %>% nrow()
numberOfTriplets <- data.road %>% select(crawl_date, rd.ri) %>% unique() %>% nrow()
numberOfTriplets == numberOfTripletsWithSTID
```

We can now proceed to isolate road status snapshots.

```{r}
data.road.status <- data.road %>% select(crawl_date, rd.ri, rd.stid) %>% unique()
glimpse(data.road.status)
```

We will use this data subset later on in visualization.



## And beyond..

```{r}
glimpse(data.road)
```

rd.rp.cmid is the id of the comment. ri is the road id. img is the user profile image id, rpImg is the id of the image attached to the report if any. strq, I guess, refers to street request? it appears any road with only one direction or segment has this set to zero, while the others are set to one. cmrq might refer to comment request?