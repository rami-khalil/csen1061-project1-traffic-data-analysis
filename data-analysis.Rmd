---
title: Traffic Data Analysis
output: html_document
---

```{r}
library(ggplot2)
library(dplyr)
library(knitr)
library(tidyr)
```

# Data Processing

## Initialization

We first load our CSV file and take a glimpse at its contents.

```{r}
data.raw <- read.csv('all-semi-unique.csv')
glimpse(data.raw)
```

At first glance, we see that our raw data is composed of approximately 430k observations of 34 variables. Let us proceed to clean this data.

## Advertising data removal

Knowing that variables prefixed with **ad.** contain information relevant only to the application's advertising logic, we may safely drop them as they will not be used in our investigation.

```{r}
data.road <- data.raw %>%
  select(-(starts_with("ad.")))
```

## Removing constant valued columns

Now that we have dropped variables that will not be of interest, we can investigate for variables that always carry a constant value in our observations

```{r}
data.road %>%
  sapply(unique) %>%
  sapply(length)
```

We can spot two variables that are always constant: **rd.cl** and **rd.rp.type**. Since they add no information to our data, we may safely discard them. We then take note of the format the *crawl_date* variable is in.

```{r}
data.road <- data.road %>%
  select(-(rd.cl), -(rd.rp.type))
head(data.road$crawl_date)
```

## Crawl date format

The crawl_date column currently contains a factor of different strings. We proceed to parse this into a more machine readable format as a column of time values.

```{r}
data.road$crawl_date <-
  strptime(data.road$crawl_date, format = "%a %b %e %X UTC %Y", tz = "UTC") %>%
  as.POSIXct()
head(data.road$crawl_date)
```

## Report submission time estimation

Upon further inspection of bey2ollak.com's response data: **rd.rp.hr** and **rd.rp.mn** are the time differences between the crawl date and the report submission time. This means we can estimate the time of the response submission accurately down to a minute, which should be sufficient for our purposes. 

```{r}
data.road <- data.road %>%
  mutate(report_time = as.POSIXct(round(crawl_date - (rd.rp.hr*60*60 + rd.rp.mn*60), "mins"))) %>%
  select(-c(rd.rp.mn, rd.rp.hr))
```

## Road status update time estimation

**rd.hr** and **rd.mn** reflect how much time has passed since a road's status was updated on bey2ollak's end. We can extrapolate the last time a road's status was updated using similar means.

```{r}
data.road <- data.road %>%
  mutate(last_road_update = as.POSIXct(round(crawl_date - (rd.hr*60*60 + rd.mn*60), "mins"))) %>%
  select(-c(rd.mn, rd.hr))
```

## Road name split

We note that **rd.nm** contains a combination of the major road name and the minor road name. Splitting this column into two separate columns will help clarify more information about major roads and their minor segments.

```{r}
data.road <- data.road %>%
  separate(rd.nm, c("rd.majornm", "rd.minornm"), ";")
```

Some reports belong to a major road name as a whole with no minor road name. We proceed to replace the missing minor road names with a standard value.

```{r}
data.road$rd.minornm[is.na(data.road$rd.minornm)] <- "NO_MINOR"
```

We will now migrate the road names data to a different data frame in order to separate concerns.

```{r}
data.road_names <- data.road %>%
  select(rd.ri, rd.majornm, rd.minornm) %>%
  unique()
num_ids <- data.road_names %>%
  select(rd.ri) %>%
  unique() %>%
  nrow()
num_entries <- data.road_names %>% nrow()
num_ids == num_entries # # check for problems, expect TRUE
rm(num_ids, num_entries) # cleanup env

data.road <- data.road %>%
  select(-c(rd.majornm, rd.minornm))
```

## Extracting road status snapshots

Each crawl of the data represents a snapshot of all the road statuses at that time if we take the right perspective. Since every entry in our data is the road status data appended to some report data, we can isolate the road status information for analysis.

First, let us ensure that we have only a single rd.stid for each road per crawl.

```{r}
numberOfTripletsWithSTID <- data.road %>%
  select(crawl_date, rd.ri, rd.stid) %>%
  unique() %>%
  nrow()
numberOfTriplets <- data.road %>%
  select(crawl_date, rd.ri) %>%
  unique() %>%
  nrow()
numberOfTriplets == numberOfTripletsWithSTID # check for problems, expect TRUE
rm(numberOfTriplets, numberOfTripletsWithSTID) # cleanup env
```

We can now proceed to isolate road status snapshots knowing that taking unique pairs will not result in information loss.

```{r}
data.road.status <- data.road %>%
  select(crawl_date, rd.ri, rd.stid) %>%
  unique()
table(data.road.status$rd.stid)
```

Unfortunately, due to the way the data was crawled, there is an overwhelming amount of rows with **rd.stid** equal to 10 (info). This destroys the information conveyed by bey2olak about the road and renders this approach useless unless we attempt to approximate the correct congestion levels.

We choose discard the polluted column and attempt to follow a different approach. As we have also chosen to disregard the "snapshots" of road status, we may also discard the **crawl_date** and **last_road_update** columns.

```{r}
rm(data.road.status)
data.road <- data.road %>%
  select(-c(rd.stid, crawl_date, last_road_update)) %>%
  unique()
```

## Application-specific data elimination

We choose to discard **rd.new**, **rd.strq**, **rd.cmrq** and **rd.img** as they play a role in bey2ollak's application functionality and will not provide traffic insight.

```{r}
data.road <- data.road %>%
  select(-c(rd.new, rd.strq, rd.cmrq, rd.img)) %>%
  unique()
```

## User information

We choose not to do any analysis on user profiles, such as inspecting wether users with profile images/full names tend to be more or less active, and drop both the **rd.rp.fullnm** and **rd.rp.img** columns.

```{r}
data.road <- data.road %>%
  select(-c(rd.rp.fullnm, rd.rp.img)) %>%
  unique()
```

## Extracting travel speeds

We will now attempt to extrapolate travel speeds so we can use them as the main metric later on in our analysis.



Knowing that **rd.rp.cmid** is the id of a report, we can isolate the report data to enable further anaylsis.

```{r}
data.road.reports <- data.road %>% 
  select(rd.ri, rd.rp.fullnm, rd.rp.stid, rd.rp.cm, rd.rp.cmid, rd.rp.rpImg, rd.rp.img, report_time, rd.majornm, rd.minornm) %>%
  unique()
data.road.reports %>% nrow() # what we have
data.road.reports %>% select(rd.rp.cmid) %>% unique() %>% nrow() # our target
```

Bey2ollak's API returns results with at most two stid tags per report. This is used in a report to indicate a road's congestion level and/or a 7adsa/khatar/3otl. Our crawling appears to have saved two entries for each report that carries two <stid> tags.

```{r}
cmid_dupes <- data.road.reports %>% select(rd.rp.cmid) %>% duplicated()
cmid_stid_dupes <- data.road.reports %>% select(rd.rp.cmid, rd.rp.stid) %>% duplicated()
mul_stid <- cmid_dupes & !cmid_stid_dupes
data.road.reports %>% subset(mul_stid) %>% arrange(desc(rd.rp.cmid)) %>% head()
```

We just have to note that due to the way we estimate the report times, some duplication of the reports will occur. We can remedy this by ignoring the possible *off-by-one* differences in **report_time** estimates resulting from our accruacy being limited to Â±1m.

```{r}
rpt_dupes <- data.road.reports %>% select(-(report_time)) %>% duplicated()

data.road.reports <- data.road.reports %>% subset(!rpt_dupes)
data.road.reports %>% nrow()
```

el data zai el zeft... kan momken n-crawl a7san mn keda b kteir

# Descriptive analysis




# Inferential analysis

## Image attachment likelihood

## Weekend night za7ma

## Weekday morning za7ma

*Take note of public holidays*


## And beyond..

```{r}
glimpse(data.road)
```

rd.rp.cmid is the id of the comment. ri is the road id. img is the user profile image id, rpImg is the id of the image attached to the report if any. strq, I guess, refers to street request? it appears any road with only one direction or segment has this set to zero, while the others are set to one. cmrq might refer to comment request?

rd.rp.stid:
1   7alawa :D 80+
2   lazeez  :) 40-79
3   mashy :| 20-39
4   za7ma  :( 10-19
5   mafeesh 2amal :'( 9-
6   so2al ?
7   khatar X
8   7adsa =:=
9   3otl /\
10  ba2olak eh !

rd.stid:
